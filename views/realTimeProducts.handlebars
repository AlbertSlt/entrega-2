<h1>Productos en Tiempo Real</h1>
<hr>

<h2>1. Crear Nuevo Producto</h2>
{{! FORMULARIO PARA HACER PETICIÓN POST A LA API HTTP }}
<form id="create-product-form">
    <input type="text" name="title" placeholder="Título" required>
    <input type="text" name="description" placeholder="Descripción" required>
    <input type="text" name="code" placeholder="Código" required>
    <input type="number" name="price" placeholder="Precio" required min="1">
    <input type="number" name="stock" placeholder="Stock" required min="0">
    <input type="text" name="category" placeholder="Categoría" required>
    <button type="submit">Crear Producto</button>
    <p id="create-message" style="color: green;"></p>
</form>

<hr>

<h2>2. Lista de Productos (Actualización Automática)</h2>

{{! CONTENEDOR!! }}

<div id="real-time-product-list" class="product-list">
    <p>Conectando al servidor y cargando productos...</p>
</div>


<script src="/socket.io/socket.io.js"></script>

<script>

    const listContainer = document.getElementById('real-time-product-list');
    const createForm = document.getElementById('create-product-form');
    const createMessage = document.getElementById('create-message');


    // conexion al serv ws
    const socket = io();


// eliminar producto, usa fetch delete
    // se llama desde el boton eliminar de la tarjeta
    const deleteProduct = async (pid) => {
        try {
            const response = await fetch(`/products/${pid}`, {
                method: 'DELETE',
            });
          
            if (!response.ok) {
                 const errorData = await response.json();
                 alert(`Error al eliminar: ${errorData.message}`);
            }
        } catch (error) {
            console.error('Error de red al eliminar:', error);
            alert('Error de conexión al intentar eliminar el producto.');
        }
    };










    // escucha de 'productsUpdate'
 
    socket.on('productsUpdate', (products) => {
        let htmlContent = ''; 

        if (products && products.length > 0) {
            products.forEach(product => {
           //gnerar html
                htmlContent += `
                    <div class="product-card">
                        <h3>${product.title} (ID: ${product.id})</h3>
                        <p>Precio: $${product.price}</p>
                        <p>Stock: ${product.stock}</p>
                        <p>Código: ${product.code}</p>
                        <button onclick="deleteProduct(${product.id})">Eliminar</button>
                    </div>
                `;
            });
            // reemplazar el contenido del contenedor con la lista actualizada
            listContainer.innerHTML = htmlContent;
        } else {
            listContainer.innerHTML = '<p>No hay productos disponibles.</p>';
        }
    });


// submit del formulario (USA FETCH POST)
    createForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = new FormData(createForm);
        const productData = Object.fromEntries(formData.entries());

        // Convertir stock y price a números
        productData.price = Number(productData.price);
        productData.stock = Number(productData.stock);

        try {
            // POST 
            const response = await fetch('/products', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(productData)
            });

            if (response.ok) {
                createMessage.textContent = 'Producto creado';
                createForm.reset();
                createMessage.style.color = 'green';
            } else {
                const errorData = await response.json();
                createMessage.textContent = `Error: ${errorData.message}`;
            }
        } catch (error) {
            createMessage.textContent = 'Error de conexión al servidor.';
            console.error('Error de red:', error);
        }

        setTimeout(() => { createMessage.textContent = ''; createMessage.style.color = 'green'; }, 5000);
    });


</script>